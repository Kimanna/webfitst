<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>어학원 홍보</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="headernav.css" rel="stylesheet">
    <link href="advertise.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="headerlocation"></div>
        <main role="main" class="container pl-1">
            <div class="division_area divbox">
                <div class="profile_area diveachbox">
                  <div>
                    <span class="red_bar"></span>
                    <div class="mypage_title">프로필</div>
                  </div>
                  <form id="profileForm" accept-charset="utf-8" enctype="multipart/form-data">
                    <input name="update_profile" type="hidden">
                      <div style="display: flex; align-items: flex-end;" class="justify-content-start">
                          <a class="profileimg">
                            <img id="profileimg">
                          </a>
                          <div style="margin-left: 30px;">
                              <div class="change_photo_area hidden">
                                <label for="change_photo">사진 변경
                                    <input type="file" name="send_photo" id="change_photo" name="profileImage" accept="image/*">
                                </label>
                              </div>
                              <div class="mypage_subtitle nickname_title">별 명</div>
                              <div class="nickname"></div>
                              <input class="input_box nickname_input hidden" name="send_nickname" type="text" maxlength="10"/>
                          </div>
                      </div>
                      <a class="btn mypage_btn profile_edit" style="font-size: 16px;">수  정</a>
                      <div class="btn_style change_btn hidden">
                          <input class="sm_btn" type="button" onclick="updateProfile('profile_save')" value="적  용">
                          <input class="sm_btn" style="margin-left: 15px;" type="button" onclick="updateProfile('profile_cencel')" value="취  소">
                      </div>
                  </form>
                </div>
                <div class="myinfo_area diveachbox">
                    <span class="red_bar"></span>
                    <div class="mypage_title">회원정보수정</div>
                    <form id="memberForm" accept-charset="utf-8" enctype="multipart/form-data">
                        <input name="update_info" type="hidden">
                        <table>
                            <tr>
                                <th class="mypage_subtitle">아이디</th>
                                <td class="info_area id"></td>
                                <td class="info_input_area hidden"><input class="input_box id_input" name="send_id" type="text" maxlength="20" disabled/></td>
                            </tr>
                            <tr>
                                <th class="mypage_subtitle">생년월일</th>
                                <td class="info_area born"></td>
                                <td class="info_input_area hidden"><input class="input_box birth_input" name="send_birth" type="text" maxlength="10"/>
                                  <div style="color:slategray;"># 예) 2000-12-22</div>
                                  <div class="birth_err hidden" style="color:red;">생년월일을 형식에 맞게 입력해 주세요.</div>
                                </td>
                            </tr>
                            <tr>
                                <th class="mypage_subtitle">성별</th>
                                <td class="info_area gender"></td>
                                <td class="info_input_area hidden">
                                    <select class="input_box gender_input" id="gender" name="send_gender" class="sel">
                                        <option value="0">성별</option>
                                        <option value="1">남자</option>
                                        <option value="2">여자</option>
                                    </select>
                                    <div class="gender_err hidden" style="color:red;">성별을 선택해 주세요.</div>
                                </td>  
                            </tr>
                            <tr>
                                <th class="mypage_subtitle">이메일</th>
                                <td class="info_area email"></td>
                                <td class="info_input_area hidden">
                                  <input class="input_box email_input" name="send_email" type="text" maxlength="40"/>
                                  <div style="color: slategray;"># 사용가능한 e-mail주소로 입력해 주세요</div>
                                  <div class="email_err hidden" style="color:red;">이메일을 형식에 맞게 입력해 주세요.</div>
                                </td>
                            </tr>
                        </table>
                        <a class="btn mypage_btn userinfo_edit" style="font-size: 16px;">수  정</a>
                        <div class="btn_style change_info_btn hidden">
                            <input class="sm_btn" type="button" onclick="updateProfile('member_info_save')" value="적  용">
                            <input class="sm_btn" style="margin-left: 15px;" type="button" onclick="updateProfile('member_info_cencel')" value="취  소">
                        </div>
                    </form>
                </div>
                <div class="writtenMe_area diveachbox">
                    <div>
                        <span class="red_bar"></span>
                        <div class="mypage_title">내가 작성한 글</div>
                    </div>
                    <ul class="writtenMe_list_review">[리뷰 목록]
                    </ul>
                    <button id="review_addbtn" class="btn more_btn" onclick="moreList('review_more');"><span style="font-size: 15px;">더보기</span></button>

                    <ul class="writtenMe_list_blog">[블로그 목록]
                    </ul>
                    <button id="blog_addbtn" class="btn more_btn" onclick="moreList('blog_more');"><span style="font-size: 15px;">더보기</span></button>
                </div>
                <div class="participating_chatroom_area diveachbox">
                  <div>
                    <span class="red_bar"></span>
                  <div class="mypage_title">내 채팅방 목록</div>
                  <ul class="myChatList">
                  </ul>
                  </div>
                </div>
            
            </div>
        </main>

        <footer class="blog-footer">
            <p>Copyright ⓒ 2020 - 2021 어학연수모임. All rights reserved.</p>
            <p>이메일 : <a href="https://getbootstrap.com/">kan12888@gmail.com</a></p>
            <p>
                <a href="#">Back to top</a>
            </p>
        </footer>
    </div>
  <script>
     $('.headerlocation').load('header.html', function (res, status, xhr) {
 
        if (status == "success" && xhr.status == 200) {
          this.innerHTML = res;

        }

    });



    // db에 저장돼있던 유저의 image경로 변수안에 저장
    var profileimg_path = '';

    // 현재 로그인중인 user 의 회원정보, Written 게시물, 데이터 가져오는 부분  
    $.getJSON( "mypage.php", {
      start_number : 0
    }, function (mypagedata){

      console.log(mypagedata);

      if (mypagedata.res == 'ok') {

        profileimg_path = mypagedata.userprofiledata.profileimg;


        // profile 부분 img/nickname
        var user_index = mypagedata.userprofiledata.auth_id; // user_index 변수

        $('#profileimg').attr('src', mypagedata.userprofiledata.profileimg);
        $('.nickname').text(mypagedata.userprofiledata.nickname);
        $('.nickname_input').attr('value',mypagedata.userprofiledata.nickname);
        


        // 회원정보부분 name,born,email,gender 
        $('.id').text(mypagedata.userprofiledata.id);
        $('.born').text(mypagedata.userprofiledata.birth);
        $('.email').text(mypagedata.userprofiledata.email);


        // 성별을 text 로 담기위한 변수
        var gender = "";

        // 1이면 남자, 2이면 여자 text 로 변환
        if (mypagedata.userprofiledata.gender == 1) gender = "남자";
        else gender = "여자";

        $('.gender').text(gender);


        // 회원정보부분 iuput 에 회원 데이터 넣어놓기
        $('.id_input').val(mypagedata.userprofiledata.id);
        $('.birth_input').val(mypagedata.userprofiledata.birth);
        $('.gender_input').val(mypagedata.userprofiledata.gender);
        $('.email_input').val(mypagedata.userprofiledata.email);



        // 내가쓴 글 목록부분 처음엔 review/blog 각 3개의 글만 보여줌    
        var review_list = mypagedata.reviewdata;
        var blog_list = mypagedata.blogdata;
        var chat_list = mypagedata.chatdata;
        
        // console.log (review_list.length);
        // console.log (review_list.length != 0);
   
           
        // review 목록을 생성하기 위한 for 문 
        // a li tag를 review_list_tag 배열에 담아서 append
        var review_list_tag = [];

        if (review_list.length == 0) {

            review_list_tag.push("<li>게시글이 없습니다.</li>");
          
        } else {

          for (var review_temp = 0 ; review_temp < review_list.length ; review_temp++) {
              review_list_tag.push("<a href='review-det.html?review_no=" + review_list[review_temp].review_no + "'><li>" + review_list[review_temp].school + "</li></a>");
          }
        }


        // blog 목록을 생성하기 위한 for 문 
        var blog_list_tag = [];
        if (blog_list.length == 0) {

            blog_list_tag.push("<li>게시글이 없습니다.</li>");
          
        } else {
          
          for (var blog_temp = 0 ; blog_temp < blog_list.length ; blog_temp++) {
              blog_list_tag.push("<a href='blog-det.html?blog_no=" + blog_list[blog_temp].blog_no + "'><li>" + blog_list[blog_temp].title + "</li></a>");
          }
        }  
        
        // 데이터가 3개보다 적으면 더보기 버튼 숨김 
        if (review_list.length < 3) $('#review_addbtn').style("display","none");
        if (blog_list.length < 3) $('#blog_addbtn').style("display","none");
    
  
        // 내가 입장한 오픈채팅방 목록
        var chat_list_tag = [];
        if (chat_list.length == 0) {

            chat_list_tag.push("<li>게시글이 없습니다.</li>");
          
        } else {
          
          for (var chat_temp = 0 ; chat_temp < chat_list.length ; chat_temp++) {
              chat_list_tag.push("<a href='http://localhost:3000/chat_room?id="+mypagedata.userprofiledata.id+"&room_type=open_chat&member_type=exist&room_no=" + chat_list[chat_temp].open_chat_no + "'><li>오픈 챗 - " + chat_list[chat_temp].chat_title + "<span>( 현재인원 : "+chat_list[chat_temp].member_count+"  /</span><span>"+chat_list[chat_temp].chat_member+" )</span></li></a>");
          }
        }
        
        $('.writtenMe_list_review').append(review_list_tag);
        $('.writtenMe_list_blog').append(blog_list_tag);
        $('.myChatList').append(chat_list_tag);

      } else {

        alert('세션이 만료되었습니다, 다시 로그인 해주세요');
        location.replace('index.html');

      }

    })




    // 더보기 버튼 onclick 에 정의된 메서드
    // 목록을 사용자가 원하는 경우 동적으로 추가하기위함
    function moreList (which_list) {

      console.log(which_list);
      
      var start_number = 0;    // 마지막 리스트 번호를 알아내기 위한 변수
      var add_list_tag = [];   // html tag 를 담기위한 변수


      if (which_list == 'review_more') {

        start_number = $('.writtenMe_list_review a').length;

      } else if (which_list == 'blog_more') {

        start_number = $('.writtenMe_list_blog a').length;

      }


      $.ajax({
        url: "mypage.php",
        type:"get",
        dataType:"json",
        data:{ "which_list" : which_list, "start_number" : start_number },

        success : function (more_data) {
          console.log(more_data);

          // review 의 더보기 버튼을 클릭한 경우
          if (which_list == 'review_more') {


            // review의 데이터가 더이상 없는경우 notok를 return 하기때문에 더보기 버튼을 지움 + 넘어온 데이터의 수가 3보다 작은경우에도 더보기 버튼을 지움
            if ( more_data.res == 'notok' ) $('#review_addbtn').remove();
            else {
              
              if (more_data.reviewdata.length < 3 ) $('#review_addbtn').remove();


              for (var review_temp = 0 ; review_temp < more_data.reviewdata.length ; review_temp++) {
                add_list_tag.push("<a href='review-det.html?review_no=" + more_data.reviewdata[review_temp].review_no + "'><li>" + more_data.reviewdata[review_temp].school + "</li></a>");
              }

              $('.writtenMe_list_review').append(add_list_tag);

            }

          } else if (which_list == 'blog_more') {


            // blog 데이터가 더이상 없는경우 notok를 return 하기때문에 더보기 버튼을 지움 + 넘어온 데이터의 수가 3보다 작은경우에도 더보기 버튼을 지움
            if ( more_data.res == 'notok' ) $('#blog_addbtn').remove();
            else {
              
              if (more_data.blogdata.length < 3 ) $('#blog_addbtn').remove();


              for (var review_temp = 0 ; review_temp < more_data.blogdata.length ; review_temp++) {
                add_list_tag.push("<a href='blog-det.html?blog_no=" + more_data.blogdata[review_temp].blog_no + "'><li>" + more_data.blogdata[review_temp].title + "</li></a>");
              }

              $('.writtenMe_list_blog').append(add_list_tag);

            }
          }

        }
      });

    }



    // *프로필 : 수정버튼 클릭시 image, nickname 이 input 값으로 변경 
    $('.profile_edit').click(function (){
      $(this).addClass('hidden'); // 수정버튼 숨김
      var nickname_value = $(this).siblings('div').find('.nickname').text();
      console.log(nickname_value);

      $('.nickname_input').val(nickname_value);
      $('.change_photo_area').removeClass('hidden'); // 사진변경버튼 보여줌
      $('.nickname').addClass('hidden'); // 기존 닉네임 숨김
      $('.nickname_input').removeClass('hidden'); // 닉네임 input 보여줌
      $('.change_btn').removeClass('hidden'); // 적용, 취소버튼 보여줌



    });

      // *회원정보 : 수정버튼 클릭시 아아디, 생년월일, 성별, 이메일 input 값으로 변경
      $('.userinfo_edit').click(function (){
      $(this).addClass('hidden'); // 수정버튼 숨김


      $('.info_input_area').removeClass('hidden');
      $('.info_area').addClass('hidden');
      $('.change_info_btn').removeClass('hidden'); // 적용, 취소버튼 보여줌

    });



    // 프로필 이미지 수정 클릭시 image바로 적용
    $('#change_photo').change(function(){
      setImageFromFile(this, '#profileimg');
      });
    
    function setImageFromFile(input, expression) {
          if (input.files && input.files[0])
          {
              var reader = new FileReader();
      
                  reader.onload = function (e) {
                      $(expression).attr('src', e.target.result);

                }
                reader.readAsDataURL(input.files[0]);

          }
    }


//     $(".birth_input").on("change keyup paste", function() {
//     var currentVal = $(this).val();

//     });

    function updateProfile(action) {

      
      if (action == 'profile_cencel') {
        console.log('프로필수정 취소클릭')
        

        $('#profileimg').attr('src', profileimg_path); // 프로필 이미지 기존 이미지로 변경해놓음
        $('.profile_edit').removeClass('hidden'); // 수정버튼 보여줌
        $('.change_photo_area').addClass('hidden'); // 사진변경버튼 숨김
        $('.nickname').removeClass('hidden'); // 기존 닉네임 보여줌
        $('.nickname_input').addClass('hidden'); // 닉네임 input 숨김
        $('.change_btn').addClass('hidden'); // 적용, 취소버튼 숨김

        return;
      }

      if (action == 'member_info_cencel') {
        console.log('회원정보수정 취소 클릭')
        
        // 취소 클릭시 기존에 저장돼있던 데이터를 input값에 다시 넣어줌
        var gender = 0;
        if ( $('.gender').text() == '남자') gender = 1
        else gender = 2

        $('.birth_input').val($('.born').text());
        $('.gender_input').val(gender);
        $('.email_input').val($('.email').text());

        
        $('.info_input_area').addClass('hidden');
        $('.info_area').removeClass('hidden');
        $('.userinfo_edit').removeClass('hidden'); // 수정버튼 보여줌
        $('.change_info_btn').addClass('hidden'); // 적용, 취소버튼 보여줌
        $('.birth_err').addClass('hidden');
        $('.gender_err').addClass('hidden');
        $('.email_err').addClass('hidden');


        return;
      }

      if (action == 'member_info_save') {
        console.log('회원정보수정 적용 클릭');

        // 생년월일 2000-12-22 정규식, email정규식
        var birthPattern = RegExp(/^(19[0-9][0-9]|20\d{2})-(0[0-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/);
        var emailPattern = /[a-z0-9]{2,}@[a-z0-9-]{2,}\.[a-z0-9]{2,}/;

        var change_birth = $('.birth_input').val();
        var change_gender = $('.gender_input').val();
        var change_email = $('.email_input').val();

        var check1 = false;
        var check2 = false;
        var check3 = false;

        if (change_birth == '' || !birthPattern.test(change_birth) ) {
          $('.birth_err').removeClass('hidden');
          check1 = false;
        } else {
          $('.birth_err').addClass('hidden');
          check1 = true;
        }

        if (change_gender == 0) {
          $('.gender_err').removeClass('hidden');
          check2 = false;
        } else {
          $('.gender_err').addClass('hidden');
          check2 = true;
        }
        if (change_email == '' || !emailPattern.test(change_email) ) {
          $('.email_err').removeClass('hidden');
          check3 = false;
        } else {
          $('.email_err').addClass('hidden');
          check3 = true;
        }
        

        // 형식에 맞지 않게 입력했거나 값을 입력하지 않은경우 return 됨
        if (check1 == false || check2 == false || check3 == false ) {
          return;
        }


            $.ajax({
                    url: "mypage.php",
                    method: "POST",
                    dataType:"json",
                    data:{ "update_info" : "update_info", "change_birth" : change_birth, "change_gender" : change_gender, "change_email" : change_email },
                    success: function (response_info) {

                      if (response_info.res == 'ok') {

                        var gend = '';
                        if (change_gender == 1) {
                          gend = '남자';
                        } else {
                          gend = '여자';
                        }

                        $('.born').text(change_birth);
                        $('.email').text(change_email);
                        $('.gender').text(gend);


                        $('.info_input_area').addClass('hidden');
                        $('.info_area').removeClass('hidden');
                        $('.userinfo_edit').removeClass('hidden'); // 수정버튼 보여줌
                        $('.change_info_btn').addClass('hidden'); // 적용, 취소버튼 보여줌

                      }
                    },
                    error: function (request,status,error) {
                      alert("code = "+ request.status + " message = " + request.responseText + " error = " + error);
                    }
                });

      }
      
      if (action == 'profile_save') {
        console.log('프로필수정 적용클릭')

        var change_nickname = $('.nickname_input').val();

        
            if ( change_nickname == '' || change_nickname == undefined ){
                alert("닉네임을 설정해 주세요.");
                return;
            }else{

              var formData = new FormData($("#profileForm")[0]);
              console.log(formData);

                  $.ajax({
                        url: "mypage.php",
                        method: "POST",
                        data: formData,
                        dataType: 'json',
                        processData: false,
                        contentType: false,
                        success: function (response_data) {

                          if (response_data.res == 'ok') {

                            $('.nickname').text(change_nickname);

                            $('.profile_edit').removeClass('hidden'); // 수정버튼 보여줌
                            $('.change_photo_area').addClass('hidden'); // 사진변경버튼 숨김
                            $('.nickname').removeClass('hidden'); // 기존 닉네임 보여줌
                            $('.nickname_input').addClass('hidden'); // 닉네임 input 숨김
                            $('.change_btn').addClass('hidden'); // 적용, 취소버튼 숨김

                          }
                        },
                        error: function (request,status,error) {
                          alert("code = "+ request.status + " message = " + request.responseText + " error = " + error);
                        }
                    });
            }
            
        return;
      }


    }


  </script>

<style>
  .hidden {
    display: none;
  }

  label {
   cursor: pointer;
   border: 1px solid #bfbfbf;
   padding: 5px 5px;
   background: #fff;
  }

  #change_photo {
    opacity: 0;
    position: absolute;
    z-index: -1;
  }
</style>

</body>
</html>

