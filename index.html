<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.1.1">
    <title>어학연수 커뮤니티</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>

    <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- Custom styles for this template -->
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="headernav.css" rel="stylesheet">
    <link href="advertise.css" rel="stylesheet">

  </head>
  <body>
    <a class="open_btn"><img src="images/go-back-left-arrow.png"></a>
    <div class="cookielocation" style="position:fixed; width:160px; right:40px; top: 50px; z-index: 1;"> 
    <a class="close"><img src="images/right-arrow-forward.png"></a>
      <div id="sidebar" style="padding: 0px 5px; border: 1px solid; background-color: white; border-color:darkgray; box-shadow: 5px 5px 10px grey; ">	
        <ul style="width:100%;padding:0;">
          <li style="font-weight: bold; text-align: center; font-size: 15px; margin-bottom: 6px; color: firebrick;">최근 방문한 후기
              <br>
            </li>
            <div style="text-align: center;">
              <div class="scrollbarauto">
            </div>
          </div>
        </ul>
      </div>
     </div> 
    <div class="container">
      <div class="headerlocation"></div>

      <div class="imgmargin text-white rounded bg-po" style="width:100%; height:250px;">
        
        <div id="myCarousel"  class="carousel slide" data-bs-ride="carousel" >
          <ol class="carousel-indicators">
            <li data-bs-target="#myCarousel" data-bs-slide-to="0" class="active"></li>
            <li data-bs-target="#myCarousel" data-bs-slide-to="1"></li>
            <li data-bs-target="#myCarousel" data-bs-slide-to="2"></li>
          </ol>
          <div class="carousel-inner">
            <div class="carousel-item active" style="background-color:dimgray;">
              <a href="review.html">
                <img src="images/thumb01.jpg" class="d-block w-100" style="object-fit: cover; height: 250px; opacity: 0.7;" alt="...">
              <div class="carousel-caption d-none d-md-block">
                <h5 style="font-size: 25px; font-weight: bold; font-family:sans-serif;">꿈, 현실이 되다!</h5>
                <p style="font-size: 17px; font-weight: bold; font-family:sans-serif;">생생한 어학연수 후기를 지금 바로 확인해 보세요!</p>
              </div></a>
            </div>
            <div class="carousel-item" style="background-color: dimgray;">
              <a href="blog.html">
              <img src="images/thumb02.png" class="d-block w-100" style="object-fit: cover; height: 250px; opacity: 0.7;" alt="..."></a>
              <div class="carousel-caption d-none d-md-block">
                <h5 style="font-size: 25px; font-weight: bold; font-family:sans-serif;">꿈같은 해외연수 경험!</h5>
                <p style="font-size: 17px; font-weight: bold; font-family:sans-serif;">해외에선 지금! 각나라별 연수생활은 어떤지 확인해 보세요!</p>
              </div></a>
            </div>
            <div class="carousel-item" style="background-color: dimgray;">
              <a href="onlineQA.html">
              <img src="images/thumb03.jpg" class="d-block w-100" style="object-fit: cover; height: 250px; opacity: 0.7;" alt="..."></a>
              <div class="carousel-caption d-none d-md-block">
                <h5 style="font-size: 25px; font-weight: bold; font-family:sans-serif;">온라인 Q&A</h5>
                <p style="font-size: 17px; font-weight: bold; font-family:sans-serif;">막연한 어학연수 생활.. 궁금한건 관리자에게 물어봐요.</p>
              </div></a>
            </div>
          </div>
          <a id="left" class="left carousel-control-prev" href="#myCarousel" role="button" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </a>
          <a id="right" class="right carousel-control-next" href="#myCarousel" role="button" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </a>
        </div>
      </div>

      <div class="bg02">
        <div class="inner" style="padding-top:10px;">
            <div class="news" style="background:#fff; padding:11px 0 0 0;">
                <div class="main_tit05">
                    <span class="red_bar"></span>
                    <a>블로그소식</a>
                    <a href="blog.html" class="r_more">[더보기+]</a>
                </div>
                <div id="GlobalList">
                  <ul class="clearfix">
                  </ul>
                </div>
            </div>
        </div>
        <div class="inner" style="padding-top:10px;">
          <div class="n_wrap">
            <div class="reviewlist mt20 mr20">
              <div class="title_box">
                <span class="red_bar"></span>
                <a>댓글 많은 글 list</a>
                <a href="blog.html" class="r_more">[더보기+]</a>
              </div>
              <ul id="blog_best_list" class="list03 typ02" style="padding: 1px 10px;">
              </ul>
            </div>
            <div class="qna mt20 mr20">
              <div class="title_box">
                <span class="red_bar"></span>
                <a>인기 채팅방 list</a>
                <a class="chat_more_bt r_more">[더보기+]</a>
              </div>
              <ul id="chat_best_list" class="list03 typ02" style="padding: 1px 10px;">
              </ul>
            </div>
          </div>
        </div>
      </div><br>
    </div>
    
<footer class="blog-footer">
  <p>Copyright ⓒ 2020 - 2021 어학연수모임. All rights reserved.</p>
  <p>이메일 : <a href="https://getbootstrap.com/">kan12888@gmail.com</a></p>
  <p>
    <a href="#">Back to top</a>
  </p>
</footer>

<script>
  $('.headerlocation').load('header.html', function (res, status, xhr) {

     if (status == "success" && xhr.status == 200) {
       this.innerHTML = res;

       // 인기채팅방 list 보여주는 부분에서 [더보기+] 버튼을 클릭한 경우 오픈챗 페이지로 할수있도록 링크를 넣어줌
       var user = $('#user_id').val();
       $('.chat_more_bt').attr('href', 'http://127.0.0.1:3000/chat_home?id='+user+'');
     }
   });


   $.getJSON("review.php", { 'rc' : 6, 'page' : 1}, function(data, status) {
     console.log(data);

     if (data.res == 'ok') {

       $('.clearfix').html(blogmain(data.data));
     }


     $('.clearfix').slick(
        {
        infinite : true, 	//무한 반복 옵션	 
        slidesToShow : 4,		// 한 화면에 보여질 컨텐츠 개수
        slidesToScroll : 1,		//스크롤 한번에 움직일 컨텐츠 개수
        speed : 100,	 // 다음 버튼 누르고 다음 화면 뜨는데까지 걸리는 시간(ms)
        arrows : true, 		// 옆으로 이동하는 화살표 표시 여부
        dots : true, 		// 스크롤바 아래 점으로 페이지네이션 여부
        vertical : false,		// 세로 방향 슬라이드 옵션
        // prevArrow : $('.slick-prev'),		// 이전 화살표 모양 설정
        // nextArrow : $('.slick-next'),		// 다음 화살표 모양 설정
        // dotsClass : "slick-dots", 	//아래 나오는 페이지네이션(점) css class 지정
        draggable : true, 	//드래그 가능 여부 
        focusOnSelect: true

      });


   })

   function blogmain (blog) {

    var bloglist = '';

    // console.log(blog);

    for (var j = 0 ; j < blog.length ; j++ ) {

      bloglist += '<div><li class="slick-slide slick-cloned">'+
                  '<a href=\"blog-det.html?blog_no='+blog[j].blog_no+'\" class=\"img\">'+
                  '<img src=\"'+blog[j].thumbnail+'\"><div class=\"red\">'+blog[j].country+'</div>'+
                  '<div class=\"tit_01\">'+blog[j].title+'</div><div class=\"txt\">'+blog[j].element+'</div></li></div>';


    }

    return bloglist;
  }
   
 
$(function(){
    // 이미지 슬라이드 컨트롤를 사용하기 위해서는 carousel를 실행해야한다.
    $('#myCarousel').carousel({
    // 슬리아딩 자동 순환 지연 시간 false면 자동 순환하지 않는다.
    interval: 3000,
    // hover를 설정하면 마우스를 가져대면 자동 순환이 멈춘다.
    pause: "hover",
    // 순환 설정, true면 1 -> 2가면 다시 1로 돌아가서 반복
    wrap: true
    });
});

// $('#myCarousel').on('slide.bs.carousel', function () {

//   // do something…
// })


  // $('.clearfix').on('click', function (e){ let slideClicked = $(e.currentTarget).attr("data-slick-index"); console.log(slideClicked); });


// 쿠키 읽어오는 함수
   var txtName = "";

// 쿠키 여부 확인
 if (document.cookie != "") {

                  
        // 여러개의 쿠키 읽어오기
        var cookies = document.cookie.split("; ");
        // console.log(cookies);

        // 쿠키 개수만큼 반복
        for (var i=0; i<cookies.length; i++) {

          
          if (cookies[i].split("=")[0] == "reviewlist11")  {
            txtName = cookies[i].split("=")[1];            
          }
        }

        // 게시물을 열람했던 기록의 쿠키가 없을때 띄워주는 메시지
        if (txtName == "") {

          
          $('.scrollbarauto').html('<div style="font-size: 12px; color:brown;">아직 게시물 방문 기록이 없습니다</div>');
          

        // 게시물 열람했던 기록이 있는경우 list 만들어서 보여줌
        } else {


          var jsonps = JSON.parse(txtName);
          var taglist = '';

          $(".scrollbarauto").html(reviewchange(jsonps));

        }
 } else {
   $('.scrollbarauto').html('<div style="font-size: 12px; color:brown;">아직 게시물 방문 기록이 없습니다</div>');

 }



 function reviewchange (reviewdata) {

    var str5 = '';

    reviewdata.forEach(function(item,index){

      if (item.type == "review") {
        var str2 = '<li><a href="review-det.html?review_no='+jsonps[index].no+'"><img src="'+jsonps[index].thumbnail+'" width="100" height="55" alt="">';
        var str3 = '</a></li><li class="titlefont" style="font-size: 14px;">'+jsonps[index].title+'<br></li><li class="datefont" style="font-size: 11px; color:dimgray; margin-bottom: 8px;">'+jsonps[index].created+'<br></li>';

        str5 += str2+str3; 
      }
      
      if (item.type == "blog") {
        var str2 = '<li><a href="blog-det.html?blog_no='+jsonps[index].no+'"><img src="'+jsonps[index].thumbnail+'" width="100" height="55" alt="">';
        var str3 = '</a></li><li class="titlefont" style="font-size: 14px;">'+jsonps[index].title+'<br></li><li class="datefont" style="font-size: 11px; color:dimgray; margin-bottom: 8px;">'+jsonps[index].created+'<br></li>';
       
        str5 += str2+str3; 
      }

     
    })

  return str5;
  }

 $(".open_btn").click(function() {
    $(".cookielocation").css('right','40px');
    $(".open_btn").css('display','none');
    $(".close").css('display','block');

 });


 $(".close").click(function() {
    $(".cookielocation").css('right','-200px');
    $(".open_btn").css('display','block');
    $(".close").css('display','none');

 });


var timeoutHnd = null; 
var logouTimeInterval =  3 * 60 * 5000; // 3 mins here u can increase session time 

OnTimeoutReached(); // 첫 로딩 시 값을 가져온 후 이후엔 3분에 한번씩 upload 중..
// 댓글 많은 글 list와 인기채팅방 list 를 가져오는 부분
function OnTimeoutReached() { 
  $.ajax({ 
          type:"get",
          dataType:"json",
          url:"search.php",
          data:{ 'MainList':'main' },
          success : function (data) {
            console.log(data);

            var blog_count = 0;
            if (data.blog_data.length < 4) {
              blog_count = data.blog_data.length;
            } else {
              blog_count = 4;
            }

            var chat_count = 0;
            if (data.chat_data.length < 4) {
              chat_count = data.chat_data.length;
            } else {
              chat_count = 4;
            }

            var blog_html = '';
            for(var temp = 0 ; temp < blog_count ; temp++) {
              blog_html += 
                          `<li>
                            <a href="blog-det.html?blog_no=${data.blog_data[temp].blog_no}">
                              <span style="color:#d9422c;">[ ${data.blog_data[temp].country} ]</span>
                              <span style="margin-left:5px;">${data.blog_data[temp].title}</span>
                              <span style="margin-left:5px;">(댓글 : ${data.blog_data[temp].comment_count})</span>
                            </a>
                          </li>`
              
            }

            var chat_html = '';
            for(var temp1 = 0 ; temp1 < chat_count ; temp1++) {
              chat_html += 
                          `<li>
                            <a class="join_open_chat" data-value="${data.chat_data[temp1].open_chat_no}">
                              <span>오픈 챗 - ${data.chat_data[temp1].chat_title}</span>
                              <span style="margin-left:5px;">(인원 : ${data.chat_data[temp1].member_count}/${data.chat_data[temp1].chat_member})</span>
                            </a>
                          </li>`
              
            }

            $('#blog_best_list').html(blog_html);
            $('#chat_best_list').html(chat_html);
            clickEvent (); // 인기채팅방 클릭 이벤트

          },
     error:function(request,status,error){
        alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
       }
     }); 

  ResetLogOutTimer(); 
} 

function ResetLogOutTimer() { 
  clearTimeout(timeoutHnd); // set new timer 
  timeoutHnd = setTimeout('OnTimeoutReached();', logouTimeInterval); 
} 
timeoutHnd = setTimeout('OnTimeoutReached();', logouTimeInterval);

function clickEvent () {
  $('.join_open_chat').on('click', function(){

    if ($('#user_id').val() == '') {
      alert('로그인 하셔야 입장 가능합니다.');
      return;
    }
    
    var user_id = $('#user_id').val();
    var room_no = $(this).attr('data-value');

    $.ajax({
      type:"get",
      dataType:"json",
      url:"search.php",
      data:{ 'checkExistMember':'check', 'user_id' : user_id, 'room_no' : room_no },
      success : function (data) {
        console.log(data);
        console.log(data.check.length > 0 );

        // 이미 입장했던 채팅방인 경우 채팅방으로 이동할 것인지 문의
        if (data.check.length > 0) {
            var returnValue = confirm('채팅방으로 이동 하시겠습니까?');
            if (returnValue) {
              window.location.href = 'http://127.0.0.1:3000/chat_room?id='+user_id+'&room_type=open_chat&member_type=exist&room_no='+room_no;
            }
        }

        // 새로운 채팅방으로 신규 입장하는경우 멤버 테이블에 유저를 저장한 후 이동
        if (data.check.length == 0) {
          var returnValue = confirm('채팅방으로 입장 하시겠습니까?');
            if (returnValue) {

              var now_time_long = new Date().valueOf(); // 현재시간 long

              $.ajax({
                      type:"get",
                      dataType:"json",
                      url:"search.php",
                      data:{ 'saveMember':'check', 'user_id' : user_id, 'room_no' : room_no, 'now_time' : now_time_long },
                      success : function (data) {
                      console.log(data.res);


                          window.location.href = 'http://127.0.0.1:3000/chat_room?id='+user_id+'&room_type=open_chat&member_type=new&room_no='+room_no;

                      }
                    });
            }
        }

      },
      error:function(request,status,error){
        alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
      } 
    })


    // var returnValue = confirm('채팅방으로 입장 하시겠습니까?');
    // if (returnValue) {

    //   window.location.href = 'http://127.0.0.1:3000/chat_room?id='+user_id+'&room_type=open_chat&room_no='+room_no;
    // }
  });
};

 </script>
 <style>
a {
  cursor: pointer;
}

 </style>

</body>
</html>